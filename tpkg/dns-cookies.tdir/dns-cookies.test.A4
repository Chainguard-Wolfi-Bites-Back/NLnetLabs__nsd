# #-- dns-cookies.pre--#
# source the master var file when it's there
[ -f ../.tpkg.var.master ] && source ../.tpkg.var.master
# use .tpkg.var.test for in test variable passing
[ -f .tpkg.var.test ] && source .tpkg.var.test
. ../common.sh

# set environment interfaces
ip address add 2001:db8:8f::53 dev lo
ip link set dev lo up

# set NSD environment variables
get_random_port 3
TPKG_PRI_PORT=$RND_PORT
TPKG_SEC_PORT=`expr $TPKG_PRI_PORT + 1`

PRE="../.."
TPKG_NSD_PRI_PID="nsd.pri.pid.$$"
TPKG_NSD_SEC_PID="nsd.sec.pid.$$"
TPKG_NSD="$PRE/nsd"

# start nsd with faketime
TZ=UTC faketime -f '2019-06-05 13:39:21' $TPKG_NSD -c dns-cookies.test.conf -P $TPKG_NSD_PRI_PID &

echo "faketime nsd instance A4 running"

sleep 1

dig -b 2001:db8:8f::53 @2001:db8:8f::53 +cookie=22681ab97d52c298010000005cf7c57926556bd0934c72f8 > dig.output.a4

if [ ! -z "$TPKG_NSD_PRI_PID" ]; then
	# kill NSD
	NSD_PRI_PID=`cat $TPKG_NSD_PRI_PID`
	kill_pid $NSD_PRI_PID
fi

if grep -q "22681ab97d52c298010000005cf7c609a6bb79d16625507a" dig.output.a4
then
	echo "A.4. Learning a New Server Cookie: Cookie matches"
	exit 0
else
	echo "A.4. Learning a New Server Cookie: Cookie does not match"
	exit 1
fi
